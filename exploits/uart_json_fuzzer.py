import serial
import time
import json
import random

# Adjust your port and baud rate
PORT = "COM7"
BAUD = 74880

# Possible commands to try over UART
commands = [
    "info",
    "switch",
    "startup",
    "pulse",
    "ota_unlock",
    "timers",
    "update",
    "reboot",
    "restart"
]

def make_packet(command):
    return {
        "deviceid": "1000abc123",  # placeholder
        "data": {},
        "seq": random.randint(100, 999),
        "cmd": command
    }

log = open("uart_json_fuzz_log.txt", "w", encoding="utf-8")

try:
    with serial.Serial(PORT, BAUD, timeout=1) as ser:
        print(f"[+] Connected to {PORT} at {BAUD} baud.")
        for i in range(30):
            cmd = random.choice(commands)
            packet = make_packet(cmd)
            payload = json.dumps(packet) + "\n"
            print(f"[>] Sending: {payload.strip()}")
            ser.write(payload.encode())
            time.sleep(0.5)
            response = ser.read(512).decode("utf-8", errors="ignore")
            print(f"[<] Response: {response.strip()}")
            log.write(f"[>] Sent: {payload.strip()}\n[<] Response: {response.strip()}\n\n")
            time.sleep(0.5)
finally:
    log.close()
    print("[+] UART JSON fuzzing complete.")
