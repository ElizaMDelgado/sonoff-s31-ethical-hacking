import serial
import time
import random

# Serial config
PORT = "COM7"     # Adjust if needed
BAUD = 74880      # Sonoff UART baud rate

# List of realistic CLI-style commands
commands = [
    "power on",
    "power off",
    "status 0",
    "status 1",
    "restart",
    "reset 1",
    "setoption19 1",
    "setoption19 0",
    "wifi_scan",
    "upgrade 1",
    "ota_unlock",
    "backlog power off; delay 10; power on",
    "friendlyname1 <script>alert(1)</script>"
]

log = open("uart_text_fuzz_log.txt", "w", encoding="utf-8")

try:
    with serial.Serial(PORT, BAUD, timeout=1) as ser:
        print(f"[+] Connected to {PORT} at {BAUD} baud.")
        for i in range(30):
            cmd = random.choice(commands)
            ser.write((cmd + "\n").encode())
            time.sleep(0.5)
            response = ser.read(512).decode("utf-8", errors="ignore")
            print(f"[>] Sent: {cmd}")
            print(f"[<] Response: {response.strip()}")
            log.write(f"[>] Sent: {cmd}\n[<] Response: {response.strip()}\n\n")
            time.sleep(0.5)
finally:
    log.close()
    print("[+] UART text fuzzing complete. Log saved.")
